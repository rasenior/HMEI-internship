```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r other-setup}
library(dplyr)
library(ggplot2)
```

This example script maps the number of bird species improving or declining in Red List status. All the data you need to run this are in the Google Drive folder:

1. "HMEI-GDrive/data/spatial/occurrence_dfs/"
  * contains occurrence dataframes for each taxonomic class
  * the file format is RDS, which is an R specific format that allows you to read in R objects directly, using the function `readRDS`
  * with the exception of the first two columns (latitude and longitude), there is one column per species
  * each row refers to a single 0.25 degree resolution grid cell
  * cell values are whether a species occurs in that grid cell (0 if no, 1 if yes)
2. "HMEI-GDrive/data/spatial/basemaps/"
  * contains country and realm basemaps
  * for now, you just need the RDS files: 'realm_df.Rds' and 'country_df.Rds'
  * similar to the above, each row refers to a single 0.25 degree resolution grid cell
  * the column 'realm'/'country' tells you which realm/country that grid cell falls in
3. the IUCN data that you're familiar with "HMEI-GDrive/data/iucn_dat.csv"
  
To follow this demo, you will need to upload all of these data to the appropriate location on Adroit. You almost certainly won't have enough RAM to run this on your own laptop! I have kept the file paths as they are for me when using Adroit, which you will obviously have to change depending on where you upload your data.

I have saved a PNG of map generated by this code at "HMEI-GDrive/data/spatial/spatial_demo.png". When you run through this code successfully, it should generate an identical map. 

```{r data}
# Main data
status_df <- 
  read.csv("/scratch/network/rsenior/iucn/iucn_dat.csv") %>% 
  mutate(
    # Reclassify category change to logical 0/1
    cat_change_bi = as.logical(factor(cat_change_bi,
                                      levels = c("improve", "decline"),
                                      labels = c(TRUE, FALSE))),
    # Match species name to how it appears in occurrence dataframe
    scientificName = gsub(" ", "_", scientificName)) %>% 
  # Filter to birds changing Red List status for a 'Genuine' reason
  filter(className == "aves",
         change_reason == "G",
         !(is.na(cat_change_bi)))

# Realm spatial dataframe
realm_df <- 
  readRDS("/scratch/network/rsenior/spatial/realm_df.Rds") %>% 
  filter(!(is.na(realm)))
```

```{r prep-occdf-fn}
# Function to prepare occurrence dataframe
# ------------------------------------------------------------------------------
# Usage:
#
# Creates a dataframe that summarises the number of species per grid cell 
# meeting with TRUE/FALSE for a given variable e.g. improving in Red List status
#
# Arguments:
# trait_df = dataframe with TRUE/FALSE values for the trait of interest, for each species
# var = the name of trait of interest within `trait_df`
# occ_df = the occurrence dataframe denoting in which grid cells each species occurs
# tax_class = the taxonomic class of interest
# mincells = the minimum required number of grid cells with non-zero number of species
# ------------------------------------------------------------------------------

prep_occdf <- function(trait_df, var, occ_df, tax_class, mincells){
  # Subset trait data to the taxonomic class and species with AOH data
  spp_df <- 
    trait_df %>%
    filter(
      # Taxonomic class
      className == tax_class,
      # Species that appear in the occurrence dataframe
      scientificName %in% colnames(occ_df))
  # Coerce variable of interest to numeric (TRUE = 1, FALSE = 0)
  spp_df[,var] <- as.numeric(spp_df[,var]) 
  # Species that have value of 1
  sppTrue <- spp_df[which(spp_df[,var] == 1), "scientificName"]
  # Species that have value of 0
  sppFalse <- spp_df[which(spp_df[,var] == 0), "scientificName"]
  
  # Return NA if there are no species (i.e. all have NA for matched action)
  if(length(sppTrue) == 0 & length(sppFalse) == 0) return(NULL)
  
  # Gather into df
  occ_df_sum <- 
    data.frame(
      # Coordinates
      lat = occ_df[,2],
      lon = occ_df[,1],
      # Number of species with TRUE
      n_spT = rowSums(occ_df[, which(colnames(occ_df) %in% sppTrue), drop = FALSE], na.rm = TRUE),
      # Number of species with FALSE
      n_spF = rowSums(occ_df[, which(colnames(occ_df) %in% sppFalse), drop = FALSE], na.rm = TRUE)
      ) %>% 
    mutate(
      # Total species
      spN = n_spT + n_spF,
      # Proportion of species within desired category
      prop = 100 * (n_spT/spN)) %>% 
    # Drop cells with zero species
    filter(spN > 0) %>% 
    mutate(className = tax_class)
  occ_df_sum[,"action"] <- var
  
  # Return
  if(nrow(occ_df_sum) < mincells) {
    return(NULL)
  }else {return(occ_df_sum)}
}
```

```{r map-birds-statusChange}
statusChange_occ_df <- 
  prep_occdf(
    trait_df = status_df,
    # Value of 1 denotes species improving in status, 0 is declining
    var = "cat_change_bi",
    occ_df = readRDS("/scratch/network/rsenior/aoh/aves_occ.Rds"),
    tax_class = "aves",
    # No minimum required
    mincells = 0)

# Map number of species improving in status (i.e. value of TRUE for cat_change_bi)
map_improve <-
  ggplot() +
  # Plot background realms
  geom_raster(data = realm_df,
              aes(x = lon, y = lat),
              fill = "grey") +
  # Plot number of amphibians per grid cell improving in Red List status
  geom_raster(data = improve_occ_df, 
              aes(x = lon, y = lat,
                  fill = n_spT)) +
  theme_void() +
  theme(legend.position = "bottom") +
  scale_fill_viridis_c(na.value = "transparent", 
                       name = "No. species improving in RL status",
                       # Manually define breaks on scale bar
                       breaks = seq(0, 100, 1)) +
  guides(fill = guide_colourbar(barwidth = unit(8, "cm"),
                                barheight = unit(0.3, "cm"),
                                title.position = "top",
                                title.hjust = 0.5))

# Map number of species declining in status (i.e. value of FALSE for cat_change_bi)
map_decline <-
  ggplot() +
  # Plot background realms
  geom_raster(data = realm_df,
              aes(x = lon, y = lat),
              fill = "grey") +
  # Plot number of amphibians per grid cell declining in Red List status
  geom_raster(data = improve_occ_df, 
              aes(x = lon, y = lat,
                  fill = n_spF)) +
  theme_void() +
  theme(legend.position = "bottom") +
  scale_fill_viridis_c(na.value = "transparent", 
                       name = "No. species declining in RL status",
                       # Manually define breaks on scale bar
                       breaks = seq(0, 100, 1)) +
  guides(fill = guide_colourbar(barwidth = unit(8, "cm"),
                                barheight = unit(0.3, "cm"),
                                title.position = "top",
                                title.hjust = 0.5))

# Plot both together
cowplot::plot_grid(map_improve, map_decline,
                   nrow = 2, ncol = 1)
```

